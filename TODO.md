# План доработки админ‑панели на Filament

## Аудит и архитектура (P0)

[x] **Проверить соответствие моделей требованиям: убедиться, что каждая модель контента (услуги, товары, категории, новости, портфолио, производственные возможности и страницы) содержит обязательные поля: title, slug, SEO (meta_title, meta_description), is_published, published_at, created_by, updated_by, deleted_by, временные метки и soft‑delete. Эти поля уже описаны в миграциях**
    *Просмотреть классы моделей (app/Models/*) и, при необходимости, добавить недостающие $fillable и $casts. Проверить миграции на наличие полей и индексов (таблица 2025_12_22_210000_create_content_entities_tables.php) и прописать nullableMorphs для media‑библиотеки.*

[x] **Проверить ресурсы Filament: в каждом ресурсе должны быть реализованы формы со всеми необходимыми полями, SEO‑секцией, секцией публикации, медиа и мета‑данными. Базовый ресурс ContentResource уже предоставляет эти секции. Нужно убедиться, что дочерние ресурсы (услуги, товары, категории, новости, портфолио, возможности, страницы) добавляют специфические поля и соблюдают уникальность slug.**
    *Пройтись по файлам App/Filament/Resources/*Resource.php и дополнить формы/таблицы. При необходимости использовать команду php artisan make:filament-resource для создания новых ресурсов или разделов.*

[] **Рефакторинг в сторону DDD и модульности: разделить код на домены: Каталог (Products, Categories, Attributes), Контент (News, Portfolio, Services, Capabilities), Формы, Меню, Настройки и Пользователи. Внутри каждого домена выделить слой приложения (Actions/Services) и слой инфраструктуры (Models/Repositories). Например, создать класс app/Domains/Catalog/Actions/PublishProduct.php для публикации товара и аналогичные классы для снятия с публикации.**
    *Создать структуру каталогов app/Domains/* и перенести соответствующие классы. Создать классы Action и DTO (например, app/Domains/Forms/Data/FormSubmissionData.php) и использовать их в контроллерах/ресурсах.*

[] **Добавить управление пользователями: создать ресурс UserResource для админ‑панели, позволяющий управлять пользователями, ролями (Spatie Roles & Permissions), полем is_active и сменой пароля.**
    *Команда php artisan make:filament-resource User --generate с дальнейшим редактированием UserResource (формы и таблицы). В формах добавить поля: имя, email, пароль, роли (SelectMultiple), флаг активности. В таблице добавить действия «блокировать/разблокировать».*

[] **Создать ресурсы для атрибутов товаров: добавить управляемые через Filament сущности ProductAttribute и ProductAttributeValue, а также менеджеры связей с категориями и товарами. Потребуется редактирование pivot‑полей: sort_order, number_value, bool_value.**
    *Использовать команды: php artisan make:filament-resource ProductAttribute --generate и php artisan make:filament-resource ProductAttributeValue --generate. Создать BelongsToManyRelationManager для привязки атрибутов к категориям и значений к товарам (с дополнительными полями).*

[] **Поддержка сортировки в M:N связях: в проектах портфолио связи с товарами и услугами используют поле sort_order. Формы ресурсов пока позволяют лишь выбрать связанные элементы без указания порядка.**
    *Создать BelongsToManyRelationManager (например, ProductPortfolioRelationManager), где в таблице отобразить поле sort_order и разрешить inline‑редактирование. Аналогично для ServicePortfolioRelationManager. Обновить PortfolioProjectResource и ProductResource для использования этих менеджеров.*

## Доработка CRUD и функционала (P0/P1)

[] **Формы и отправки: завершить функционал конструктора форм. Формы (FormResource) уже имеют поля для заголовка, получателей, сообщения, anti‑spam (Turnstile/honeypot). Нужно реализовать отправку писем, управление статусом отправок, отображение полей в нужном порядке, возможность выгрузки CSV, уведомления администраторов.**
    *В app/Domains/Forms/Actions создать классы: SubmitFormAction, SendFormSubmissionNotificationJob. В контроллере обработать сохранение FormSubmission, отправку письма (используя Mailables) и прикрепление файлов. В ресурсах Forms добавить Bulk actions для экспорта и пометки спама.*

[] **Контактные формы: предусмотреть хранение и настройку полей контактной формы (название, email, телефон) в ContactSettings. Реализовать настройку капчи (Turnstile/Honeypot) через .env и возможность включения/выключения в админке.**
    *В SiteSettings добавить секцию «Форма обратной связи» с переключателями для капчи, настройкой темы письма и текстами ответов пользователю. Убедиться, что при включении капчи форма на фронте выводит компонент Turnstile.*

[] **Управление меню: реализовать drag‑and‑drop сортировку для пунктов меню и поддержку вложенности. MenuItemsRelationManager уже имеет поля и типы ссылок. Необходимо добавить возможность визуально перемещать пункты (ReorderableList) и редактировать параметры маршрута и привязки к моделям.**
    *Использовать Filament\Pages\Concerns\InteractsWithTableReorder или встроенный ReorderTableRows в таблицах. Обновить MenuResource и relation‑manager.*

[] **Поля по умолчанию: заполнение meta_title и meta_description значениями по умолчанию (например, из основного заголовка и вырезки) при создании записи.**
    *В ContentModel в методе booted() добавить логику генерации SEO‑полей, если пользователь оставил их пустыми.*

[] **Система страниц (Fabricator): проверить интеграцию Filament Fabricator для создания страниц и блоков. Убедиться, что главная страница (home) создаётся сидером, что поддерживаются черновики и предпросмотр. Добавить в админке управление блоками страницы.**
    *Создать собственный ресурс/страницу, расширяющую PageResource пакета Fabricator, чтобы добавить функции черновиков, публикации и SEO.*

[] **Управление сообщениями о статусе отправки: для форм предусмотреть возможность отправки уведомлений в мессенджеры (Telegram/Slack) или email. Реализовать настройки webhook для интеграций.**
    *Добавить в форму поле webhook_url (оно уже присутствует), реализовать Job для отправки POST‑запроса на указанный URL при новой заявке.*

[] **Резервное копирование и импорт: добавить экспорт и импорт данных (товаров, услуг, новостей, меню) в CSV/Excel.**
    *Использовать пакет Spatie/laravel-export или встроенные возможности Filament (например, Tables\Actions\ExportAction). Создать соответствующие bulk‑actions в таблицах.*

[] **Мультиязычность (при необходимости): подготовить модели и ресурсы для локализации (laravel‑translatable, Filament Localization).**
    *Изучить пакет Astrotomic/laravel-translatable и предусмотреть миграции для хранения переводов.*

## Безопасность и надёжность (P0)

[] **Политики доступа: определить и создать Policy для каждой модели (content, forms, menus, settings, users). Вынести проверки в Policy и регистрировать их в AuthServiceProvider. Использовать enum Permission для проверки прав (просмотр, создание, обновление, удаление, публикация, просмотр черновиков).**
    *Команды: php artisan make:policy ProductPolicy --model=Product, аналогично для остальных. Внутри методов использовать hasRole()/hasPermissionTo() от Spatie. В Filament‑ресурсе определить методы canView, canCreate, canDelete и т. д., делегирующие в Policy.*

[] **Предпросмотр и черновики: обеспечить безопасность предпросмотра черновиков: добавлять в мета‑теги значение noindex,nofollow, скрывать от поисковых систем и проверять право доступа (только автор и администраторы).**
    *В ContentResource переопределить метод getPreviewUrl() для генерации временной подписи (например, через signedRoute) и добавить middleware, проверяющий подпись и разрешения. В blade‑шаблоне для предпросмотра вывести тег <meta name=robots content=noindex,nofollow>.*

[] **Валидация и санитизация: проверить правила валидации для всех полей. Убедиться, что поля со slug уникальны, поля email/URL валидируются, HTML‑контент очищается (Laravel Purifier).**
    *Добавить правила в модели и в ресурсы. Использовать пакет HTMLPurifier или strip_tags для очистки html‑полей.*

[] **Анти‑спам: активировать Turnstile (Cloudflare) и honeypot в формах, как предусмотрено в FormResource. Обеспечить проверку токена на сервере и возможность отключения в настройках.**
    *Добавить сервисный класс TurnstileService для валидации токена, получить секретный ключ из .env. Создать настройки в SiteSettings для включения/выключения капчи.*

[] **Проверка загружаемых файлов: контролировать типы и размеры файлов, загружаемых через формы и media‑библиотеку.**
    *В ресурсах для медиа указать доступные mime‑типы и максимальный размер. Проверить, что поля alt и title у изображений обязательны.*

[] **Логи и аудит: логировать действия пользователей (создание, изменение, удаление, публикация). Можно использовать пакет Spatie Activitylog, который уже импортирован для некоторых моделей.**
    *Настроить глобальные вызовы activity() или Observer’ы для записи действий. Создать страницу в админке для просмотра логов.*

[] **Блокировка пользователей: реализовать механизм блокировки неактивных администраторов через поле is_active. При авторизации Filament уже проверяет это поле, но нужна страница для изменения статуса и разлогинивания заблокированных.**
    *В UserResource добавить toggle is_active и действие «Заблокировать».*

## Качество кода и тесты (P1)

[] **Статический анализ и стандарты: интегрировать PHPStan/Larastan и Pint. Настроить конфигурацию (например, phpstan.neon) и добавить скрипты в composer.json.**
    *Добавить зависимость phpstan/phpstan и nunomaduro/larastan через composer. Создать конфигурационный файл phpstan.neon (уровень 7), настроить исключения. Добавить в composer.json script pint для автоформатирования.*

[] **Покрытие тестами: расширить существующие тесты (tests/Feature/QualityAssuranceTest.php) для проверки: публикации/снятия с публикации, работы черновиков, уникальности slug, наличия alt/title у изображений, отправки форм, уведомлений, прав доступа, сортировки меню и M:N связей, настройки SEO и контактов.**
    *Создать отдельные файлы тестов в tests/Feature для каждого домена (CatalogTest, ContentTest, FormsTest, MenuTest, SettingsTest). Использовать filament/actions для тестирования Filament (пакет filamentphp/filament-testing при наличии).*

[] **Проверка миграций и индексов: написать тесты, которые сверяют наличие внешних ключей с поведением set null на userstamps и каскадное удаление pivot‑таблиц, как уже частично проверяется в QA‑тесте.**
    *Дополнить QualityAssuranceTest проверками на наличие индексов, внешних ключей и уникальных ограничений.*

## Интерфейс и UX для админа (P1)

[] **Структура навигации: сгруппировать меню админ‑панели по домейнам: «Каталог» (Товары, Категории, Атрибуты), «Контент» (Услуги, Новости, Портфолио, Производственные возможности), «Формы», «Меню и страницы», «Настройки», «Пользователи».**
    *В каждом ресурсе задать navigationGroup и, при необходимости, navigationIcon.*

[] **Dashboard: реализовать дашборд с виджетами: количество опубликованных/неопубликованных записей, последние отправки форм, статус заказов.**
    *Создать страницу Dashboard с несколькими Filament\Widgets\StatsOverviewWidget и виджетом для последних заявок.*

[] **Inline‑редактирование и подтверждения: разрешить редактировать некоторые поля прямо в таблицах (например, sort_order, is_published), добавив кастомные колонки и actions. Для опасных действий (удаление, снятие с публикации, восстановление) добавить диалог подтверждения.**
    *В таблицах использовать TextColumn::make()->editable() и ToggleColumn::make('is_published') с обработчиком onChange. Для подтверждений использовать Action::make('Delete')->requiresConfirmation().*

[] **Покрытие ошибок: добавить всплывающие уведомления об успехе/ошибках при создании, обновлении или удалении сущностей.**
    *Использовать Notification::make() в методах afterCreate, afterUpdate и т. д.*

## Подготовка к релизу (P2)

[] **Оптимизация и кеширование: перед релизом выполнить php artisan config:cache, route:cache, view:cache, проверить, что .env настроен на production (APP_ENV=production, APP_DEBUG=false).**
    *Добавить инструкцию в README и деплой‑скрипт.*

[] **Документация для конечного пользователя: подготовить руководство для клиента по использованию админ‑панели: как создавать и публиковать записи, управлять меню, работать с формами, изменять настройки сайта.**
    *Создать файл docs/admin-guide.md и заполнить разделы. Предоставить доступ через маршрут в админке или экспортировать PDF.*

[] **Мониторинг и резервное копирование: настроить регулярные резервные копии базы и файлов (Laravel Backup), а также мониторинг ошибок (Sentry/Bugsnag).**
    *Установить пакет spatie/laravel-backup, настроить расписание backup:run в Kernel. Интегрировать сторонний мониторинг.*

[] **Проверка на staging: развернуть копию сайта на тестовом сервере, импортировать демо‑данные, провести пользовательское тестирование и принять обратную связь.**
    *Создать ветку release-candidate, задеплоить, собрать замечания, подготовить changelog.*

## Завершение

Следуя этому плану, команда сможет привести админ‑панель к готовому продукту, соответствующему заявленным требованиям. Приоритет P0 обозначает обязательные задачи для первого релиза; P1 — важные для качества и удобства, но могут быть выполнены во вторую очередь; P2 — улучшения и рекомендации, которые можно внедрять по мере необходимости после основного запуска.
